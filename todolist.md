# Task Tracker

- Context reset (2025-12-04): reviewed prior Typst badge/navigation work, re-read latest docs/spec.md and docs/api.md, confirmed no open TODOs or dirty tasks before starting global badge UX change.
- Context reset (2025-12-05): reviewed screenshot of missing global Typst image, re-read updated docs/spec.md and docs/api.md, noted no pending code tasks; environment synced locally and test data unchanged.
- Context reset (2025-12-06): re-read docs/spec.md and docs/api.md for navigation expectations, confirmed prior Typst/nav tasks closed, no open TODOs, workspace clean; ready to remove sidebar nav from series Typst page.
- Context reset (2025-12-06, later): revisited docs/spec.md and docs/api.md after sidebar removal, noted need to revert series Typst page back to shared sidebar pattern; no other changes pending.
- Context reset (2025-12-07): re-read docs/spec.md and docs/api.md, noted new requirement to remember imported global template per series server-side; confirmed todolist closed tasks and no dirty workspaces before starting preference persistence work.
- Context reset (2025-12-04 - latex toggle persistence): re-read docs/spec.md and docs/api.md, noted new requirement to persist the Catalog UI Latex Templating toggle per series; no open TODOs carried over, workspace clean, test data unchanged.
- Context reset (2025-12-04 - category fields scoping): re-read docs/spec.md and docs/api.md, confirmed new ask to scope Category Fields panel per category node; workspace clean, no open TODOs, ready to document and implement per-category field storage.
- Context reset (2025-12-08 - category fields search cleanup): re-read docs/spec.md and docs/api.md, confirmed prior tasks closed, workspace clean; ready to remove duplicate Category Fields search input.
- Context reset (2025-12-08 - category fields visibility): re-read docs/spec.md and docs/api.md, noted reports that non-root categories could not save/list Category Fields; no open TODOs, workspace clean, test data unchanged; ready to refresh docs/api and fix UI behavior.
- Context reset (2025-12-08 - category fields button alignment): re-read updated docs/spec.md and docs/api.md, confirmed no open TODOs; environment ready to adjust Category Fields Editor button alignment.
- Context reset (2025-12-08 - spec search results columns): re-read docs/spec.md and docs/api.md after prior tasks, confirmed no open TODOs and workspace clean; no test data refresh needed; ready to document and remove Spec Search results table raw ID columns.
- Context reset (2025-12-08 - spec search series image column): re-read updated docs/spec.md and docs/api.md, confirmed prior tasks closed; workspace clean, no new test data; ready to add series metadata image column to Spec Search.
- Context reset (2025-12-08 - spec search series image URL normalization): re-read updated docs/spec.md and docs/api.md, confirmed prior tasks closed; workspace clean; ready to normalize series image paths so they render.
- Context reset (2025-12-08 - spec search PDF download column): re-read docs/spec.md and docs/api.md, confirmed prior tasks closed; workspace clean; ready to add PDF download column with Typst/series_product_spec logic.

## Tasks
1) **Update spec.md with architecture + diagrams** - Status: Done. Test approach: manual review plus optional check `if (-not (Select-String -Path .\docs\spec.md -Pattern '```mermaid' -Quiet)) { throw "docs/spec.md must contain Mermaid diagrams." }`.
2) **Draft api.md for REST endpoints** - Status: Done. Test approach: manual verification against `public/api/*` handlers and ensure error envelope examples present.
3) **Write AGENTS.md contributor guide** - Status: Done. Test approach: manual proofreading for clarity and alignment with repository conventions once drafted.
4) **Add line-numbered editor wrapper to Global Typst template page** - Status: Done. Test approach: manual UI check in browser ensuring numbers sync with scroll/input.
5) **Add line-numbered editor wrapper to Series Typst template page** - Status: Done. Test approach: manual UI check in browser ensuring numbers sync with scroll/input.
6) **Fix PDF download for saved Typst templates when no stored URL** - Status: Done. Test approach: manual check on global_typst_template.html saved templates table ensuring PDF Download triggers compile+opens.
7) **Enable PDF download button even when no prior URL exists** - Status: Done. Test approach: ensure button stays enabled when Typst content exists and triggers compile-then-open flow.
8) **Sanitize Typst data header keys for series templates** - Status: Done. Test approach: `php -l app/Typst/TypstService.php`; manual compile on `series_typst_template.html?series_id=<id>` with custom fields containing dots/unsafe characters to confirm PDF renders.
9) **Document sidebar nav standardization in spec/api** - Status: Done. Test approach: manual doc review ensuring new navigation note present.
10) **Align sidebar links across operator UIs** - Status: Done. Test approach: manual HTML review plus ripgrep to confirm href targets (spec-search, catalog UI, catalog CSV, global Typst, series Typst) with no dead links.
11) **Persist Typst PDF path when saving series templates (Save PDF / Save & Compile)** - Status: Completed (manual UI verify recommended). Test approach: manual flow on `series_typst_template.html?series_id=<id>` to compile+save then verify `typst_templates.last_pdf_path` updates; `php -l` on touched PHP files and smoke compile to confirm URL+path returned.
12) **Document Typst badge insertion behavior (series)** - Status: Done. Test approach: manual doc review ensuring spec.md/api.md describe badge key-only rendering and insertion tokens.
13) **Series Typst badges show Typst-safe keys and paste tokens into editor** - Status: Completed. Test approach: `node --check public/assets/js/series-typst-templating.js`; manual UI check on `series_typst_template.html?series_id=<id>` still recommended to confirm badge insertion + compile preview.
14) **Group series custom-field badges under products wrapper** - Status: Done. Test approach: manual UI check on `series_typst_template.html?series_id=<id>` to confirm outer products badge inserts loop scaffold, inner badges insert `product.attributes.<key>` and compile still works.
15) **Add product name/sku badges to series custom fields** - Status: Done. Test approach: manual UI check on `series_typst_template.html?series_id=<id>` ensuring `product.sku` and `product.name` badges appear inside products wrapper and insert correct tokens.
16) **Document global Typst badge insertion and placeholder mapping** - Status: Done. Test approach: manual doc review ensuring docs/spec.md and docs/api.md mention badge tokens and compile placeholder replacements.
17) **Render global Typst variables as badges that insert tokens into the editor and compile with actual values** - Status: Done. Test approach: manual UI check on `global_typst_template.html` (badge click inserts at caret, compile shows value), `node --check public/assets/js/global-typst-templating.js` for syntax, and optional manual compile to verify PDF updates.
18) **Switch Global Variables list to Bootstrap 5 DataTable (Field Key / Field Type / Field Data) with row-click insertion** - Status: Done. Test approach: `node --check public/assets/js/global-typst-templating.js`; manual UI verification recommended to confirm search + row click inserts `{{key}}` at caret and selection populates the form.
19) **Add edit button to Global Variables table and restrict insertion to key badge** - Status: Done. Test approach: `node --check public/assets/js/global-typst-templating.js`; manual UI verify badge click inserts token only, Edit button loads Variable Setup without inserting.
20) **Add “Add” button to Variable Setup to clear form for new variable creation** - Status: Done. Test approach: manual UI check on `global_typst_template.html` that Add clears the form and deselects current row; `node --check public/assets/js/global-typst-templating.js`.
21) **Show image preview for file/image variables in Global Variables table** - Status: Done. Test approach: `node --check public/assets/js/global-typst-templating.js`; manual UI verify image thumbnail appears in Field Data when type is file/image.
22) **Resolve image preview using stored physical path (serve web URL) for global variables** - Status: Done. Test approach: `node --check public/assets/js/global-typst-templating.js`; manual UI check that previously broken image values now show thumbnails when paths exist under public/public/storage.
23) **Fallback to data URI for image previews when only physical path exists** - Status: Done. Test approach: `node --check public/assets/js/global-typst-templating.js`; manual UI verify images stored as physical paths outside public show in table.
24) **Document global Typst asset upload requirement (spec/api)** - Status: Done. Test approach: manual doc review ensuring spec.md decisions and api.md Typst variables section note multipart upload to `public/storage/typst-assets/`.
25) **Add upload pipeline for global Typst file/image variables (UI + API)** - Status: Done. Test approach: manual UI save with image recommended; executed `node --check public/assets/js/global-typst-templating.js` and `php -l public/api/typst/variables.php app/Typst/TypstService.php`.
26) **Ensure Typst compile uses uploaded global assets (stage into build + placeholder map)** - Status: Done. Test approach: linted `app/Typst/TypstService.php`; manual compile in `global_typst_template.html` with `#image("{{key}}")` recommended to confirm PDF renders uploaded asset.
27) **Fix global variables image cell layout (thumbnail above path) & relative preview URL** - Status: Done. Test approach: `node --check public/assets/js/global-typst-templating.js`; `php -l app/Typst/TypstService.php`; manual UI check to confirm thumbnail loads and path text sits beneath.
28) **Remove sidebar navigation from series Typst page** - Status: Reverted. Test approach: superseded by task 29.
29) **Restore sidebar navigation on series Typst page** - Status: Done. Test approach: manual UI check on `series_typst_template.html` verifying sidebar back and links match other operator UIs; no automated checks run.
30) **Remember last imported global Typst template per series (server-side preference + UI pre-select)** - Status: Done. Test approach: `php -l` on new/changed Typst PHP files and preference API; `node --check public/assets/js/series-typst-templating.js`; manual UI check on `series_typst_template.html?series_id=<id>` verifying dropdown pre-selects stored global template when still available, persists selection on Import, and clears gracefully when template is missing.
31) **Document latex templating enablement persistence (spec/api)** - Status: Done. Test approach: manual doc review to confirm spec.md data model/ER and docs/api.md Catalog section describe the latex templating flag and persistence flow.
32) **Persist Typst templating flag per series (schema + API)** - Status: Done. Test approach: `php -l catalog.php app/Catalog/CatalogService.php`; manual API check recommended to ensure hierarchy/set endpoints return the stored flag.
33) **Wire catalog UI toggle to stored Typst templating flag** - Status: Done. Test approach: `node --check public/assets/js/catalog_ui.js`; manual UI toggle on `catalog_ui.html` to ensure state persists across reloads after enable/disable.
34) **Document per-category fields panel scope (spec/api)** - Status: Done. Test approach: manual doc review verifying docs/spec.md and docs/api.md describe Category Fields panel visibility rules and per-category storage (Mermaid presence intact).
35) **Backend support for category-scoped fields via Typst variables API** - Status: Done. Test approach: `php -l app/Typst/TypstService.php public/api/typst/variables.php`; optional curl/Insomnia smoke to list/create/delete with seriesId for a category; ensure uploads still accepted.
36) **Scope Category Fields panel to category nodes in catalog UI** - Status: Done. Test approach: `node --check public/assets/js/catalog_ui.js`; manual UI click-through on `catalog_ui.html` verifying panel hides for non-category nodes and fields stay isolated per category ID; optional API log review.
37) **Remove duplicate Category Fields search input/id** - Status: Done. Test approach: manual UI load of `catalog_ui.html` confirming the DataTable search box remains and no extra search input/id is present; `node --check public/assets/js/catalog_ui.js` for syntax.
38) **Document Category Fields refresh per category** - Status: Done. Test approach: manual doc review confirming spec.md/api.md call out clearing DataTable state when switching categories.
39) **Reset Category Fields table state per category selection (non-root visibility)** - Status: Done. Test approach: `node --check public/assets/js/catalog_ui.js`; manual UI check on `catalog_ui.html` (applied search filter on root, switched to child category, confirmed search cleared and scoped fields show/saved).
40) **Align Category Fields Editor buttons (Add left, Save/Delete right)** - Status: Done. Test approach: manual UI check on `catalog_ui.html` confirming Add button is left-aligned and Save/Delete group is right-aligned within the form.
41) **Document Spec Search results table column scope (hide raw IDs)** - Status: Done. Test approach: manual doc review ensuring docs/spec.md Key Processes and Decisions note the table excludes `seriesId`/`categoryId`.
42) **Remove seriesId/categoryId columns from Spec Search results table** - Status: Done. Test approach: `node --check assets/js/spec_search.js` executed; manual UI check on `spec-search.html` verifying results table omits ID columns while still showing SKU/Name/Series/Category and dynamic attributes.
43) **Document Spec Search series image column** - Status: Done. Test approach: manual doc review verifying docs/spec.md and docs/api.md call out the Series Image column sourced from `series_product_image`.
44) **Add Series Image column to Spec Search (series metadata `series_product_image`)** - Status: Done. Test approach: `php -l app/SpecSearch/SpecSearchService.php`, `node --check assets/js/spec_search.js`, `node --check public/assets/js/spec_search.js`; manual UI check on `spec-search.html` still recommended to confirm image column appears before SKU and hides when no value.
45) **Normalize Spec Search series image paths to web-safe URLs** - Status: Done. Test approach: `php -l app/SpecSearch/SpecSearchService.php`, `node --check assets/js/spec_search.js`, `node --check public/assets/js/spec_search.js`; manual UI check on `spec-search.html` verifying images load (no broken links).
46) **Document Spec Search PDF download column logic (Typst vs series_product_spec)** - Status: Done. Test approach: manual doc review ensuring docs/spec.md and docs/api.md describe the PDF download column and source precedence.
47) **Add PDF download column to Spec Search (Typst on -> latest Typst PDF; else series_product_spec)** - Status: Done. Test approach: `php -l app/SpecSearch/SpecSearchService.php`; `node --check assets/js/spec_search.js` and `node --check public/assets/js/spec_search.js`; manual UI check on `spec-search.html` verifying PDF Download links render when data present and use correct source.
