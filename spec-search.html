<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Search / Spec Search</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables CSS & JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h2,
        h3,
        h4 {
            margin-top: 0;
        }

        /* --- Section 1: Root & Product Category --- */
        .search-section {
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .root-category-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }

        .root-category-row label {
            font-weight: bold;
            margin-right: 10px;
        }

        .radio-group label {
            font-weight: normal;
            margin-right: 15px;
            cursor: pointer;
        }

        .product-category-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .category-group {
            min-width: 200px;
        }

        .category-group h4 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #555;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .category-list li {
            margin-bottom: 5px;
        }

        .category-list label {
            cursor: pointer;
            font-size: 14px;
        }

        /* --- Section 2: Mechanical Parameters (Facets) --- */
        .facets-section {
            margin-bottom: 30px;
        }

        .facets-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            /* Horizontal scroll for panels */
            padding-bottom: 15px;
            /* Space for scrollbar */
            border: 1px solid #eee;
            padding: 15px;
            background: #fafafa;
            border-radius: 5px;
        }

        /* Custom scrollbar for x-axis */
        .facets-container::-webkit-scrollbar {
            height: 8px;
        }

        .facets-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .facet-panel {
            min-width: 200px;
            width: 200px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            /* Prevent shrinking */
        }

        .facet-header {
            padding: 10px;
            background: #eee;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }

        .facet-search {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .facet-search input {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .facet-values {
            height: 200px;
            overflow-y: auto;
            /* Vertical scroll for values */
            padding: 8px;
        }

        /* Custom scrollbar for y-axis */
        .facet-values::-webkit-scrollbar {
            width: 6px;
        }

        .facet-values::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .facet-item {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            cursor: pointer;
        }

        .facet-item input {
            margin-right: 8px;
        }

        /* --- Section 3: Results --- */
        .results-section {
            margin-top: 20px;
        }

        table.dataTable thead th {
            background-color: #333;
            color: #fff;
        }

        .btn-edit {
            display: inline-block;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-size: 12px;
        }

        .btn-edit:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- SECTION 1: Product Search -->
        <div class="search-section">
            <h2>Product Search</h2>

            <!-- 1.1 Root Category -->
            <div class="root-category-row">
                <label>Filter Product By:</label>
                <div class="radio-group" id="root-category-container">
                    <!-- Populated by JS -->
                    Loading...
                </div>
            </div>

            <!-- 1.2 Product Category -->
            <div id="product-category-wrapper">
                <h3>Product Categories</h3>
                <div class="product-category-container" id="product-category-container">
                    <!-- Populated by JS -->
                    <p style="color: #888;">Select a root category to see product categories.</p>
                </div>
            </div>
        </div>

        <!-- SECTION 2: Mechanical Parameters -->
        <div class="facets-section">
            <h3>Mechanical Parameters</h3>
            <div class="facets-container" id="facets-container">
                <!-- Facet Panels Populated by JS -->
                <p style="color: #888; padding: 10px;">Select product categories to see filters.</p>
            </div>
        </div>

        <!-- SECTION 3: Results -->
        <div class="results-section">
            <h3>Results</h3>
            <table id="results-table" class="display" style="width:100%">
                <thead>
                    <tr id="table-headers">
                        <!-- Headers Populated by JS -->
                        <th>Series</th>
                        <th>SKU</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows Populated by DataTables -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        $(document).ready(function () {

            // --- Configuration ---
            // Use relative path so it works regardless of the project folder name (e.g. /test/ or /project/)
            const API_BASE = 'api/spec-search';
            let dataTable = null;

            // --- 1. Load Root Categories ---
            function loadRootCategories() {
                $.getJSON(API_BASE + '/root-categories/index.php', function (data) {
                    const container = $('#root-category-container');

                    if (data.error) {
                        console.error("API Error:", data.error);
                        container.html('<span style="color:red;">' + data.error + '</span>');
                        return;
                    }

                    if (!Array.isArray(data)) {
                        console.error("API Error: Unexpected response format", data);
                        container.html('<span style="color:red;">Error: Unexpected API response.</span>');
                        return;
                    }

                    container.empty();

                    if (data.length === 0) {
                        container.html('<span>No root categories found.</span>');
                        return;
                    }

                    data.forEach((cat, index) => {
                        const checked = index === 0 ? 'checked' : '';
                        container.append(`
                    <label>
                        <input type="radio" name="root_category" value="${cat.id}" ${checked}>
                        ${cat.name}
                    </label>
                `);
                    });

                    // Trigger change to load product categories for default selection
                    $('input[name="root_category"]:checked').trigger('change');
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    console.error("API Error:", textStatus, errorThrown);
                    $('#root-category-container').html('<span style="color:red;">Error loading categories. Please ensure you are running this on a PHP server (localhost) and the API path is correct.</span>');
                });
            }

            // --- Event: Root Category Changed ---
            $(document).on('change', 'input[name="root_category"]', function () {
                const rootId = $(this).val();
                loadProductCategories(rootId);

                // Clear facets and table
                $('#facets-container').html('<p style="color: #888; padding: 10px;">Select product categories to see filters.</p>');
                if (dataTable) {
                    dataTable.clear().draw();
                    // Optionally destroy/reset headers if they change dynamically
                }
            });

            // --- 2. Load Product Categories ---
            function loadProductCategories(rootId) {
                $.getJSON(API_BASE + '/product-categories/index.php', { root_id: rootId }, function (data) {
                    const container = $('#product-category-container');
                    container.empty();

                    if (data.length === 0) {
                        container.html('<p>No categories found.</p>');
                        return;
                    }

                    data.forEach(group => {
                        let catsHtml = '';
                        group.categories.forEach(cat => {
                            catsHtml += `
                        <li>
                            <label>
                                <input type="checkbox" class="product-cat-checkbox" value="${cat.id}">
                                ${cat.name}
                            </label>
                        </li>
                    `;
                        });

                        container.append(`
                    <div class="category-group">
                        <h4>${group.group}</h4>
                        <ul class="category-list">
                            ${catsHtml}
                        </ul>
                    </div>
                `);
                    });
                });
            }

            // --- Event: Product Category Checkbox Changed ---
            $(document).on('change', '.product-cat-checkbox', function () {
                loadFacets();
                loadProducts(); // Also reload products immediately? Or wait for facets? 
                // Usually good to reload products based on category selection too.
            });

            // --- 3. Load Facets ---
            function loadFacets() {
                const rootId = $('input[name="root_category"]:checked').val();
                const catIds = $('.product-cat-checkbox:checked').map(function () { return $(this).val(); }).get();

                if (catIds.length === 0) {
                    $('#facets-container').html('<p style="color: #888; padding: 10px;">Select product categories to see filters.</p>');
                    return;
                }

                $.ajax({
                    url: API_BASE + '/facets/index.php',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ root_id: rootId, category_ids: catIds }),
                    success: function (data) {
                        if (data.error) {
                            console.error("Facets API Error:", data.error);
                            $('#facets-container').html('<span style="color:red;">' + data.error + '</span>');
                            return;
                        }
                        renderFacets(data);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("Facets API Request Failed:", textStatus, errorThrown);
                        console.log("Response Text:", jqXHR.responseText);
                        $('#facets-container').html('<span style="color:red;">Error loading filters. See console for details.</span>');
                    }
                });
            }

            function renderFacets(facets) {
                const container = $('#facets-container');
                container.empty();

                facets.forEach(facet => {
                    let valuesHtml = '';
                    facet.values.forEach(val => {
                        valuesHtml += `
                    <label class="facet-item">
                        <input type="checkbox" class="facet-value-checkbox" data-facet-key="${facet.key}" value="${val}">
                        ${val}
                    </label>
                `;
                    });

                    const panel = `
                <div class="facet-panel">
                    <div class="facet-header">${facet.label}</div>
                    <div class="facet-search">
                        <input type="text" placeholder="Search..." class="facet-filter-input">
                    </div>
                    <div class="facet-values">
                        ${valuesHtml}
                    </div>
                </div>
            `;
                    container.append(panel);
                });
            }

            // --- Client-side Facet Filter (Search within panel) ---
            $(document).on('keyup', '.facet-filter-input', function () {
                const term = $(this).val().toLowerCase();
                const panel = $(this).closest('.facet-panel');
                panel.find('.facet-item').each(function () {
                    const text = $(this).text().toLowerCase();
                    $(this).toggle(text.indexOf(term) > -1);
                });
            });

            // --- Event: Facet Value Changed ---
            $(document).on('change', '.facet-value-checkbox', function () {
                loadProducts();
            });

            // --- 4. Load Products (DataTables) ---
            function loadProducts() {
                const rootId = $('input[name="root_category"]:checked').val();
                const catIds = $('.product-cat-checkbox:checked').map(function () { return $(this).val(); }).get();

                // Collect facet filters
                const filters = {};
                $('.facet-value-checkbox:checked').each(function () {
                    const key = $(this).data('facet-key');
                    const val = $(this).val();
                    if (!filters[key]) filters[key] = [];
                    filters[key].push(val);
                });

                // Prepare request body
                const requestData = {
                    root_id: rootId,
                    category_ids: catIds,
                    filters: filters
                };

                // If DataTables is already initialized, destroy it to re-init with potentially new columns
                // OR just reload data if columns are static. 
                // For this demo, let's assume dynamic columns might be needed, but for simplicity we'll stick to fixed columns + dynamic data first.
                // If columns need to change based on category, we'd need to rebuild the table structure.
                // Let's assume a standard set of columns for now or rebuild.

                // Re-fetching data
                $.ajax({
                    url: API_BASE + '/products/index.php',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function (response) {
                        initDataTable(response);
                    }
                });
            }

            function initDataTable(products) {
                // Define columns dynamically based on the first product or a fixed schema
                // For this demo, we'll try to be smart.

                if (products.length === 0) {
                    if (dataTable) {
                        dataTable.clear().draw();
                    }
                    return;
                }

                // Extract all keys from first product to build headers
                // In a real app, the API should probably return column definitions too.
                const firstItem = products[0];
                const columns = [];

                // Always put Series and SKU first
                if (firstItem.hasOwnProperty('series')) columns.push({ title: 'Series', data: 'series' });
                if (firstItem.hasOwnProperty('sku')) columns.push({ title: 'SKU', data: 'sku' });

                // Add other keys
                Object.keys(firstItem).forEach(key => {
                    if (key !== 'series' && key !== 'sku' && key !== 'id') {
                        columns.push({ title: key.charAt(0).toUpperCase() + key.slice(1), data: key });
                    }
                });

                // Add Action column
                columns.push({
                    title: 'Action',
                    data: null,
                    render: function (data, type, row) {
                        return `<a href="catalog.php?sku=${row.sku}" class="btn-edit" target="_blank">Edit</a>`;
                    }
                });

                // Destroy existing
                if (dataTable) {
                    dataTable.destroy();
                    $('#results-table').empty(); // Clear headers
                }

                $('#results-table').DataTable({
                    data: products,
                    columns: columns,
                    pageLength: 10,
                    destroy: true // Allow re-init
                });
            }

            // --- Init ---
            loadRootCategories();

        });
    </script>

</body>

</html>