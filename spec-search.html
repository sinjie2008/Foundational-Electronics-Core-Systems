<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Search / Spec Search</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables CSS & JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h2,
        h3,
        h4 {
            margin-top: 0;
        }

        /* --- Section 1: Root & Product Category --- */
        .search-section {
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .root-category-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }

        .root-category-row label {
            font-weight: bold;
            margin-right: 10px;
        }

        .radio-group label {
            font-weight: normal;
            margin-right: 15px;
            cursor: pointer;
        }

        .product-category-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .category-group {
            min-width: 200px;
        }

        .category-group h4 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #555;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .category-list li {
            margin-bottom: 5px;
        }

        .category-list label {
            cursor: pointer;
            font-size: 14px;
        }

        /* --- Section 2: Mechanical Parameters (Facets) --- */
        .facets-section {
            margin-bottom: 30px;
        }

        .facets-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            /* Horizontal scroll for panels */
            padding-bottom: 15px;
            /* Space for scrollbar */
            border: 1px solid #eee;
            padding: 15px;
            background: #fafafa;
            border-radius: 5px;
        }

        /* Custom scrollbar for x-axis */
        .facets-container::-webkit-scrollbar {
            height: 8px;
        }

        .facets-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .facet-panel {
            min-width: 200px;
            width: 200px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            /* Prevent shrinking */
        }

        .facet-header {
            padding: 10px;
            background: #eee;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }

        .facet-search {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .facet-search input {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .facet-values {
            height: 200px;
            overflow-y: auto;
            /* Vertical scroll for values */
            padding: 8px;
        }

        /* Custom scrollbar for y-axis */
        .facet-values::-webkit-scrollbar {
            width: 6px;
        }

        .facet-values::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .facet-item {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            cursor: pointer;
        }

        .facet-item input {
            margin-right: 8px;
        }

        /* --- Section 3: Results --- */
        .results-section {
            margin-top: 20px;
        }

        table.dataTable thead th {
            background-color: #333;
            color: #fff;
        }

        .btn-edit {
            display: inline-block;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-size: 12px;
        }

        .btn-edit:hover {
            background-color: #0056b3;
        }

        /* Fix DataTables alignment issues */
        table.dataTable th,
        table.dataTable td {
            white-space: nowrap;
            box-sizing: border-box;
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- SECTION 1: Product Search -->
        <div class="search-section">
            <h2>Product Search</h2>

            <!-- 1.1 Root Category -->
            <div class="root-category-row">
                <label>Filter Product By:</label>
                <div class="radio-group" id="root-category-container">
                    <!-- Populated by JS -->
                    Loading...
                </div>
            </div>

            <!-- 1.2 Product Category -->
            <div id="product-category-wrapper">
                <h3>Product Categories</h3>
                <div class="product-category-container" id="product-category-container">
                    <!-- Populated by JS -->
                    <p style="color: #888;">Select a root category to see product categories.</p>
                </div>
            </div>
        </div>

        <!-- SECTION 2: Mechanical Parameters -->
        <div class="facets-section">
            <h3>Mechanical Parameters</h3>
            <div class="facets-container" id="facets-container">
                <!-- Facet Panels Populated by JS -->
                <p style="color: #888; padding: 10px;">Select product categories to see filters.</p>
            </div>
        </div>

        <!-- SECTION 3: Results -->
        <div class="results-section">
            <h3>Results</h3>
            <table id="results-table" class="display" style="width:100%">
                <thead>
                    <tr id="table-headers">
                        <!-- Headers Populated by JS -->
                        <th>Series</th>
                        <th>SKU</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows Populated by DataTables -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        $(document).ready(function () {

            // --- Configuration ---
            // Use relative path so it works regardless of the project folder name (e.g. /test/ or /project/)
            const API_BASE = 'api/spec-search';
            let dataTable = null;
            let currentFacets = []; // Store facets to build table headers

            // --- 1. Load Root Categories ---
            function loadRootCategories() {
                $.getJSON(API_BASE + '/root-categories/index.php', function (data) {
                    const container = $('#root-category-container');

                    if (data.error) {
                        console.error("API Error:", data.error);
                        container.html('<span style="color:red;">' + data.error + '</span>');
                        return;
                    }

                    if (!Array.isArray(data)) {
                        console.error("API Error: Unexpected response format", data);
                        container.html('<span style="color:red;">Error: Unexpected API response.</span>');
                        return;
                    }

                    container.empty();

                    if (data.length === 0) {
                        container.html('<span>No root categories found.</span>');
                        return;
                    }

                    data.forEach((cat, index) => {
                        const checked = index === 0 ? 'checked' : '';
                        container.append(`
                    <label>
                        <input type="radio" name="root_category" value="${cat.id}" ${checked}>
                        ${cat.name}
                    </label>
                `);
                    });

                    // Trigger change to load product categories for default selection
                    $('input[name="root_category"]:checked').trigger('change');
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    console.error("API Error:", textStatus, errorThrown);
                    $('#root-category-container').html('<span style="color:red;">Error loading categories. Please ensure you are running this on a PHP server (localhost) and the API path is correct.</span>');
                });
            }

            // --- Event: Root Category Changed ---
            $(document).on('change', 'input[name="root_category"]', function () {
                const rootId = $(this).val();
                loadProductCategories(rootId);

                // Clear facets and table
                $('#facets-container').html('<p style="color: #888; padding: 10px;">Select product categories to see filters.</p>');
                currentFacets = []; // Clear stored facets
                if (dataTable) {
                    dataTable.destroy();
                }
                $('#results-table').empty(); // Clear headers too
            });

            // --- 2. Load Product Categories ---
            function loadProductCategories(rootId) {
                $.getJSON(API_BASE + '/product-categories/index.php', { root_id: rootId }, function (data) {
                    const container = $('#product-category-container');
                    container.empty();

                    if (data.length === 0) {
                        container.html('<p>No categories found.</p>');
                        return;
                    }

                    data.forEach(group => {
                        let catsHtml = '';
                        group.categories.forEach(cat => {
                            catsHtml += `
                        <li>
                            <label>
                                <input type="checkbox" class="product-cat-checkbox" value="${cat.id}">
                                ${cat.name}
                            </label>
                        </li>
                    `;
                        });

                        container.append(`
                    <div class="category-group">
                        <h4>${group.group}</h4>
                        <ul class="category-list">
                            ${catsHtml}
                        </ul>
                    </div>
                `);
                    });
                });
            }

            // --- Event: Product Category Checkbox Changed ---
            $(document).on('change', '.product-cat-checkbox', function () {
                loadFacets();
                // We wait for facets to load before loading products, 
                // because we need facets to build table headers.
            });

            // --- 3. Load Facets ---
            function loadFacets() {
                const rootId = $('input[name="root_category"]:checked').val();
                const catIds = $('.product-cat-checkbox:checked').map(function () { return $(this).val(); }).get();

                if (catIds.length === 0) {
                    $('#facets-container').html('<p style="color: #888; padding: 10px;">Select product categories to see filters.</p>');
                    currentFacets = [];
                    return;
                }

                $.ajax({
                    url: API_BASE + '/facets/index.php',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ root_id: rootId, category_ids: catIds }),
                    success: function (data) {
                        if (data.error) {
                            console.error("Facets API Error:", data.error);
                            $('#facets-container').html('<span style="color:red;">' + data.error + '</span>');
                            return;
                        }
                        currentFacets = data; // Store for headers
                        renderFacets(data);
                        loadProducts(); // Load products after facets are ready
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("Facets API Request Failed:", textStatus, errorThrown);
                        console.log("Response Text:", jqXHR.responseText);
                        $('#facets-container').html('<span style="color:red;">Error loading filters. See console for details.</span>');
                    }
                });
            }

            function renderFacets(facets) {
                const container = $('#facets-container');
                container.empty();

                facets.forEach(facet => {
                    let valuesHtml = '';
                    facet.values.forEach(val => {
                        valuesHtml += `
                    <label class="facet-item">
                        <input type="checkbox" class="facet-value-checkbox" data-facet-key="${facet.key}" value="${val}">
                        ${val}
                    </label>
                `;
                    });

                    const panel = `
                <div class="facet-panel">
                    <div class="facet-header">${facet.label}</div>
                    <div class="facet-search">
                        <input type="text" placeholder="Search..." class="facet-filter-input">
                    </div>
                    <div class="facet-values">
                        ${valuesHtml}
                    </div>
                </div>
            `;
                    container.append(panel);
                });
            }

            // --- Client-side Facet Filter (Search within panel) ---
            $(document).on('keyup', '.facet-filter-input', function () {
                const term = $(this).val().toLowerCase();
                const panel = $(this).closest('.facet-panel');
                panel.find('.facet-item').each(function () {
                    const text = $(this).text().toLowerCase();
                    $(this).toggle(text.indexOf(term) > -1);
                });
            });

            // --- Event: Facet Value Changed ---
            $(document).on('change', '.facet-value-checkbox', function () {
                loadProducts();
            });

            // --- 4. Load Products (DataTables) ---
            function loadProducts() {
                const rootId = $('input[name="root_category"]:checked').val();
                const catIds = $('.product-cat-checkbox:checked').map(function () { return $(this).val(); }).get();

                // Collect facet filters
                const filters = {};
                $('.facet-value-checkbox:checked').each(function () {
                    const key = $(this).data('facet-key');
                    const val = $(this).val();
                    if (!filters[key]) filters[key] = [];
                    filters[key].push(val);
                });

                console.log("Loading products with filters:", filters); // Debug log

                // Prepare request body
                const requestData = {
                    root_id: rootId,
                    category_ids: catIds,
                    filters: filters
                };

                // Re-fetching data
                $.ajax({
                    url: API_BASE + '/products/index.php',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function (response) {
                        initDataTable(response);
                    }
                });
            }

            function initDataTable(products) {
                // Define columns based on currentFacets
                const columns = [];

                // Fixed Columns
                columns.push({ title: 'Series', data: 'series' });
                columns.push({ title: 'SKU', data: 'sku' });

                // Dynamic Columns from Facets
                // We use the 'key' from the facet as the data source.
                // Note: If keys contain dots (e.g. 'acf.length'), we need to handle them carefully.
                // DataTables treats dots as nested objects. If our JSON is flat {"acf.length": "val"}, 
                // we should use a render function or escape the key.
                // Simplest way for flat keys with dots: use array notation or a function.

                if (currentFacets && currentFacets.length > 0) {
                    currentFacets.forEach(facet => {
                        // Exclude 'series' if it's also a facet, as it's already added as a fixed column
                        if (facet.key !== 'series' && facet.key !== 'sku') {
                            columns.push({
                                title: facet.label,
                                data: null, // Use null data source and render manually to handle special chars in keys
                                render: function (data, type, row) {
                                    return row[facet.key] || '';
                                }
                            });
                        }
                    });
                }

                // Action Column
                columns.push({
                    title: 'Action',
                    data: null,
                    render: function (data, type, row) {
                        return `<a href="catalog.php?sku=${row.sku}" class="btn-edit" target="_blank">Edit</a>`;
                    }
                });

                // Destroy existing instance if present
                if (dataTable) {
                    dataTable.destroy();
                }

                // Always clear the table content (headers and body) to allow dynamic regeneration
                $('#results-table').empty();

                dataTable = $('#results-table').DataTable({
                    data: products,
                    columns: columns,
                    pageLength: 10,
                    destroy: true, // Allow re-init
                    scrollX: true, // Enable horizontal scroll if many columns
                    autoWidth: false, // Disable auto-width calculation to prevent misalignment
                    initComplete: function () {
                        // Force adjustment of columns after initialization
                        this.api().columns.adjust();
                    }
                });
            }

            // --- Init ---
            loadRootCategories();

        });
    </script>

</body>

</html>